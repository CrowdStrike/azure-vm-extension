{
  "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
  "handler": "Microsoft.Azure.CreateUIDef",
  "version": "0.1.2-preview",
  "parameters": {
    "basics": [
      {
        "name": "policyInfo",
        "type": "Microsoft.Common.InfoBox",
        "visible": true,
        "options": {
          "icon": "Info",
          "text": "This template deploys Azure Policy for automatic CrowdStrike Falcon installation at subscription level using official CrowdStrike VM extensions."
        }
      }
    ],
    "steps": [
      {
        "name": "policySettings",
        "label": "Policy Configuration",
        "elements": [
          {
            "name": "operatingSystem",
            "type": "Microsoft.Common.OptionsGroup",
            "label": "Operating System",
            "defaultValue": "linux",
            "toolTip": "Select the operating system for CrowdStrike Falcon deployment",
              "constraints": {
                "allowedValues": [
                  {
                    "label": "Linux",
                    "value": "linux"
                  },
                  {
                    "label": "Windows",
                    "value": "windows"
                  },
                  {
                    "label": "Both",
                    "value": "both"
                  }
                ],
                "required": true
              }
          },
          {
            "name": "createRoleAssignments",
            "type": "Microsoft.Common.CheckBox",
            "label": "Create Role Assignments",
            "defaultValue": false,
            "toolTip": "Create role assignments for policy managed identities (requires Owner or User Access Administrator role)"
          },
          {
            "name": "policyEffect",
            "type": "Microsoft.Common.DropDown",
            "label": "Policy Effect",
            "defaultValue": "DeployIfNotExists",
            "toolTip": "Select the policy effect",
            "constraints": {
              "allowedValues": [
                {
                  "label": "Deploy If Not Exists",
                  "value": "DeployIfNotExists"
                },
                {
                  "label": "Audit If Not Exists",
                  "value": "AuditIfNotExists"
                },
                {
                  "label": "Disabled",
                  "value": "Disabled"
                }
              ],
              "required": true
            }
          }
        ]
      },
      {
        "name": "falconApiConfig",
        "label": "Falcon API Configuration",
        "elements": [
          {
            "name": "authType",
            "type": "Microsoft.Common.OptionsGroup",
            "label": "Authentication Method",
            "defaultValue": "OAuth2 Credentials",
            "toolTip": "Select the authentication method for the CrowdStrike Falcon Platform",
            "constraints": {
              "allowedValues": [
                {
                  "label": "OAuth2 Credentials",
                  "value": "oauth2Creds"
                },
                {
                  "label": "Access Token",
                  "value": "accessToken"
                }
              ],
              "required": true
            }
          },
          {
            "name": "clientId",
            "type": "Microsoft.Common.TextBox",
            "label": "Client ID",
            "toolTip": "Client ID for accessing CrowdStrike Falcon Platform",
            "constraints": {
              "required": "[equals(steps('falconApiConfig').authType, 'oauth2Creds')]",
              "regex": "^.+$",
              "validationMessage": "Client ID is required for OAuth2 authentication"
            },
            "visible": "[equals(steps('falconApiConfig').authType, 'oauth2Creds')]"
          },
          {
            "name": "clientSecret",
            "type": "Microsoft.Common.PasswordBox",
            "label": {
              "password": "Client Secret"
            },
            "toolTip": "Client Secret for accessing CrowdStrike Falcon Platform",
            "constraints": {
              "required": "[equals(steps('falconApiConfig').authType, 'oauth2Creds')]",
              "regex": "^.+$",
              "validationMessage": "Client Secret is required for OAuth2 authentication"
            },
            "options": {
              "hideConfirmation": true
            },
            "visible": "[equals(steps('falconApiConfig').authType, 'oauth2Creds')]"
          },
          {
            "name": "accessToken",
            "type": "Microsoft.Common.PasswordBox",
            "label": {
              "password": "Access Token"
            },
            "toolTip": "Access token for accessing CrowdStrike Falcon Platform",
            "constraints": {
              "required": "[equals(steps('falconApiConfig').authType, 'accessToken')]",
              "regex": "^.+$",
              "validationMessage": "Access Token is required"
            },
            "options": {
              "hideConfirmation": true
            },
            "visible": "[equals(steps('falconApiConfig').authType, 'accessToken')]"
          },
          {
            "name": "cloud",
            "type": "Microsoft.Common.DropDown",
            "label": "Falcon Cloud",
            "defaultValue": "Auto Discover (Recommended)",
            "toolTip": "Falcon cloud abbreviation. Auto Discover is recommended and will automatically determine the correct cloud.",
            "constraints": {
              "allowedValues": [
                {
                  "label": "Auto Discover (Recommended)",
                  "value": "autodiscover"
                },
                {
                  "label": "US-1",
                  "value": "us-1"
                },
                {
                  "label": "US-2",
                  "value": "us-2"
                },
                {
                  "label": "EU-1",
                  "value": "eu-1"
                }
              ],
              "required": true
            }
          },
          {
            "name": "memberCid",
            "type": "Microsoft.Common.TextBox",
            "label": "Member CID (MSSP)",
            "defaultValue": "",
            "toolTip": "Member CID for MSSP (for cases when OAuth2 authenticates multiple CIDs)",
            "constraints": {
              "required": false,
              "regex": "^([0-9a-fA-F]{32})?$",
              "validationMessage": "Please enter a valid 32-character CID or leave empty"
            }
          }
        ]
      },
      {
        "name": "sensorConfig",
        "label": "Basic Sensor Configuration",
        "elements": [
          {
            "name": "sensorUpdatePolicy",
            "type": "Microsoft.Common.TextBox",
            "label": "Sensor Update Policy",
            "defaultValue": "platform_default",
            "toolTip": "The sensor update policy name to use for sensor installation",
            "constraints": {
              "required": false
            }
          },
          {
            "name": "tags",
            "type": "Microsoft.Common.TextBox",
            "label": "Sensor Tags",
            "defaultValue": "",
            "toolTip": "A comma separated list of tags for sensor grouping",
            "constraints": {
              "required": false
            }
          }
        ]
      }
    ],
    "outputs": {
      "operatingSystem": "[steps('policySettings').operatingSystem]",
      "policyAssignmentName": "[concat('CS-Deploy-Falcon-', steps('policySettings').operatingSystem, '-Subscription')]",
      "policyDefinitionName": "[concat('CS-Falcon-', steps('policySettings').operatingSystem, '-Subscription')]",
      "policyEffect": "[steps('policySettings').policyEffect]",
      "createRoleAssignments": "[steps('policySettings').createRoleAssignments]",
      "location": "[location()]",
      "accessToken": "[if(equals(steps('falconApiConfig').authType, 'accessToken'), steps('falconApiConfig').accessToken, '')]",
      "clientId": "[if(equals(steps('falconApiConfig').authType, 'oauth2Creds'), steps('falconApiConfig').clientId, '')]",
      "clientSecret": "[if(equals(steps('falconApiConfig').authType, 'oauth2Creds'), steps('falconApiConfig').clientSecret, '')]",
      "cloud": "[steps('falconApiConfig').cloud]",
      "memberCid": "[steps('falconApiConfig').memberCid]",
      "sensorUpdatePolicy": "[steps('sensorConfig').sensorUpdatePolicy]",
      "disableProxy": false,
      "provisioningToken": "",
      "proxyHost": "",
      "proxyPort": "",
      "tags": "[steps('sensorConfig').tags]",
      "pacUrl": "",
      "disableProvisioningWait": false,
      "disableStart": false,
      "provisioningWaitTime": "1200000",
      "vdi": false
    }
  }
}
